<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Painel OSINT Unificado</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body>
    <header>
        <h1>Painel OSINT Unificado</h1>
        <nav>
            <a href="{{ url_for('index') }}">🏠 Início</a>
            <a href="{{ url_for('vazamento') }}">📧 Vazamento</a>
            <a href="{{ url_for('metaweb') }}">📂 MetaWeb</a>
            <a href="{{ url_for('sherlock') }}">🕵 Sherlock</a>
            <a href="{{ url_for('ajuda') }}">❓ Ajuda</a>
        </nav>
        <button id="darkModeToggle" aria-label="Alternar modo escuro">🌙</button>
    </header>

    <main>
        {% block content %}{% endblock %}
    </main>

    <footer id="footer">
        <small>🔍 Painel OSINT Unificado</small>
    </footer>

    <!-- Loader com porcentagem -->
    <div id="loader" style="display:none;">
        <div class="spinner"></div>
        <div id="loader-progress" class="loader-panel" role="status" aria-live="polite">
            <div class="loader-title">Processando…</div>
            <div class="progress-wrap">
                <div class="progress-bar" id="loader-progress-bar" style="width: 0%"></div>
            </div>
            <div class="progress-text" id="loader-progress-text">0%</div>
            <div class="progress-sub" id="loader-progress-sub"></div>
        </div>
    </div>

    <script>
        const toggle = document.getElementById('darkModeToggle');
        const body = document.body;

        // Preservar tema
        if (localStorage.getItem('theme') === 'dark') {
            body.classList.add('dark-mode');
            toggle.textContent = '☀️';
        } else {
            toggle.textContent = '🌙';
        }

        toggle.onclick = () => {
            body.classList.toggle('dark-mode');
            if (body.classList.contains('dark-mode')) {
                localStorage.setItem('theme', 'dark');
                toggle.textContent = '☀️';
            } else {
                localStorage.setItem('theme', 'light');
                toggle.textContent = '🌙';
            }
        };

        function showLoader() {
            const el = document.getElementById("loader");
            if (el) el.style.display = "flex";
        }

        function hideLoader() {
            const el = document.getElementById("loader");
            if (el) el.style.display = "none";
        }

        function setLoaderProgress(pct = 0, msg = "") {
            const bar = document.getElementById('loader-progress-bar');
            const txt = document.getElementById('loader-progress-text');
            const sub = document.getElementById('loader-progress-sub');
            if (bar) bar.style.width = pct + "%";
            if (txt) txt.textContent = pct + "%";
            if (sub) sub.textContent = msg;
        }

        function setupProgressEventSource(url, onComplete) {
            showLoader();
            setLoaderProgress(1, "Iniciando...");
            const es = new EventSource(url);

            es.addEventListener("progress", ev => {
                try {
                    const data = JSON.parse(ev.data);
                    setLoaderProgress(data.percent || 0, data.message || "");
                } catch (_) {}
            });

            es.addEventListener("payload", ev => {
                try {
                    const data = JSON.parse(ev.data);
                    if (onComplete) onComplete(data);
                } catch (_) {}
            });

            es.addEventListener("complete", () => {
                setLoaderProgress(100, "Concluído.");
                setTimeout(hideLoader, 300);
                es.close();
            });

            es.addEventListener("error", () => {
                alert("Erro no processamento.");
                hideLoader();
                es.close();
            });

            return es;
        }

        // Padrões para cada ferramenta
        window.startSherlockProgress = (taskId, onComplete) =>
            setupProgressEventSource(`/sherlock_progress/${taskId}`, onComplete);

        window.startVazamentoProgress = (taskId, onComplete) =>
            setupProgressEventSource(`/vazamento_progress/${taskId}`, onComplete);

        window.startMetawebProgress = (taskId, onComplete) =>
            setupProgressEventSource(`/metaweb_progress/${taskId}`, onComplete);
    </script>
</body>
</html>
