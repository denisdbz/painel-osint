{% extends "base.html" %}
{% block content %}
<h2>MetaWeb - AnÃ¡lise de Metadados</h2>

<form id="metawebForm" enctype="multipart/form-data">
    <input type="file" name="file" required>
    <button type="submit">Enviar e Analisar</button>
</form>

{% if error %}
<p class="error">{{ error }}</p>
{% endif %}

<hr>

<div id="metaweb-resultado" style="display:none;">
    <h3>Resultados</h3>
    <div id="metaweb-output"></div>
    <a href="{{ url_for('metaweb') }}" class="botao-voltar">ðŸ”„ Nova anÃ¡lise</a>
</div>

<script>
const form = document.getElementById('metawebForm');
form.addEventListener('submit', async function(e) {
    e.preventDefault();
    const fd = new FormData(form);

    const resp = await fetch("{{ url_for('metaweb_start') }}", { method: 'POST', body: fd });
    const json = await resp.json();
    if (!json.ok) {
        alert(json.error || "Erro ao iniciar anÃ¡lise");
        return;
    }

    const taskId = json.task_id;
    window.startMetawebProgress(taskId, (payload) => {
        let html = "";
        if (payload && payload.resultado) {
            for (let tool in payload.resultado) {
                const val = payload.resultado[tool];
                html += `<h4>${tool}</h4><pre>${val ? String(val) : ""}</pre>`;
            }
        }
        document.getElementById('metaweb-output').innerHTML = html;
        document.getElementById('metaweb-resultado').style.display = 'block';
    });
});
</script>
{% endblock %}
